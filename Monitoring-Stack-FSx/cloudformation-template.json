{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label" : {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VpcId",
                        "SubnetIds",
                        "SecurityGroupIds",
                        "DeploymentMode",
                        "CreateFsxServiceEndpoint",
                        "CreateSecretManagerEndpoint",
                        "CreateCloudWatchMonitoringEndpoint",
                        "CreateCloudWatchLogsEndpoint",
                        "LambdaRoleArn",
                        "SchedulerRoleArn"
                    ]
                },
                {
                    "Label" : {
                        "default": "Passwords Configuration"
                    },
                    "Parameters": [
                        "PasswordsSecretArn"
                    ]
                },
                {
                    "Label": {
                        "default": "Lambda Configuration"
                    },
                    "Parameters": [
                        "SnsTopicArn",
                        "EmsScheduleExpression",
                        "EmsLogGroupName",
                        "CreateEmsLogGroup"
                    ]
                },
                {
                    "Label": {
                        "default": "Usage Data"
                    },
                    "Parameters": [
                        "SendUsage"
                    ]
                }                
            ],
            "ParameterLabels": {
                "VpcId": {
                    "default": "VPC ID"
                },
                "SubnetIds": {
                    "default": "Subnet IDs"
                },
                "SecurityGroupIds": {
                    "default": "Security Group IDs"
                },
                "CreateFsxServiceEndpoint": {
                    "default": "Create FSx Service VPC Endpoint"
                },
                "CreateSecretManagerEndpoint": {
                    "default": "Create Secrets Manager VPC Endpoint"
                },
                "CreateCloudWatchMonitoringEndpoint": {
                    "default": "Create CloudWatch VPC Endpoint"
                },
                "CreateCloudWatchLogsEndpoint": {
                    "default": "Create CloudWatch Logs VPC Endpoint"
                },
                "LambdaRoleArn": {
                    "default": "Lambda Role ARN"
                },
                "SchedulerRoleArn": {
                    "default": "Scheduler Role ARN"
                },
                "DeploymentMode": {
                    "default": "Deployment Mode"
                },
                "PasswordsSecretArn": {
                    "default": "FSx Admin Passwords Secret ARN"
                },
                "SnsTopicArn": {
                    "default": "SNS Topic ARN"
                },
                "EmsScheduleExpression": {
                    "default": "EMS Collection Interval (Minutes)"
                },
                "EmsLogGroupName": {
                    "default": "EMS Log Group Name"
                },
                "CreateEmsLogGroup": {
                    "default": "Create EMS Log Group"
                },
                "SendUsage": {
                    "default": "Send Usage Data"
                }
            }
        }
    },
    "Parameters": {
        "VpcId": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "The VPC ID where the Lambda function will be deployed"
        },
        "SubnetIds": {
            "Type": "List<AWS::EC2::Subnet::Id>",
            "Description": "The subnet IDs where the Lambda function will run"
        },
        "SecurityGroupIds": {
            "Type": "List<AWS::EC2::SecurityGroup::Id>",
            "Description": "The security group IDs for the Lambda function"
        },
        "CreateFsxServiceEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "Create FSx Service VPC endpoint"
        },
        "CreateSecretManagerEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "Create Secrets Manager VPC endpoint"
        },
        "CreateCloudWatchMonitoringEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "Create CloudWatch VPC endpoint"
        },
        "CreateCloudWatchLogsEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "Create CloudWatch Logs VPC endpoint"
        },
        "LambdaRoleArn": {
            "Type": "String",
            "Default": "",
            "Description": "Optional: Existing Lambda execution role ARN. If not provided, a new role will be created."
        },
        "SchedulerRoleArn": {
            "Type": "String",
            "Default": "",
            "Description": "Optional: Existing EventBridge Scheduler execution role ARN. If not provided, a new role will be created."
        },
        "DeploymentMode": {
            "Type": "String",
            "AllowedValues": [
                "FSx Metrics, FSx Alerts, EMS Logs",
                "FSx Metrics, FSx Alerts",
                "FSx EMS Logs"
            ],
            "Default": "FSx Metrics, FSx Alerts, EMS Logs",
            "Description": "Choose which components to deploy: Full monitoring with EMS logs, Monitoring without EMS, or EMS logs only"
        },
        "PasswordsSecretArn": {
            "Type": "String",
            "Description": "The ARN of the AWS Secrets Manager secret containing fsxadmin passwords for ONTAP file systems"
        },
        "SnsTopicArn": {
            "Type": "String",
            "Description": "Optional: The ARN of the SNS topic for CloudWatch alarms",
            "Default": ""
        },
        "SendUsage": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "true",
            "Description": "Send usage data"
        },
        "EmsScheduleExpression": {
            "Type": "Number",
            "Default": 5,
            "MinValue": 1,
            "MaxValue": 1440,
            "Description": "EMS logs collection interval in minutes (1-1440 minutes, i.e., 1 minute to 24 hours)",
            "ConstraintDescription": "Must be a number between 1 and 1440 (minutes)"
        },
        "EmsLogGroupName": {
            "Type": "String",
            "Default": "fsx-ems-logs",
            "Description": "Name of the CloudWatch Log Group for EMS logs",
            "AllowedPattern": "^[a-zA-Z0-9_\\-\\.]{1,512}$",
            "ConstraintDescription": "Log group name must be 1-512 characters and contain only letters, numbers, underscores, hyphens, and periods"
        },
        "CreateEmsLogGroup": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "true",
            "Description": "Create new CloudWatch Log Group for EMS logs. Set to false if log group already exists."
        }
    },
    "Conditions": {
        "NeedToCreateLambdaRole": {
            "Fn::Equals": [
                {
                    "Ref": "LambdaRoleArn"
                },
                ""
            ]
        },
        "NeedToCreateSchedulerRole": {
            "Fn::Equals": [
                {
                    "Ref": "SchedulerRoleArn"
                },
                ""
            ]
        },
        "NeedToCreateFsxServiceEndpoint": {
            "Fn::Equals": [
                {
                    "Ref": "CreateFsxServiceEndpoint"
                },
                "true"
            ]
        },
        "NeedToCreateSecretManagerEndpoint": {
            "Fn::Equals": [
                {
                    "Ref": "CreateSecretManagerEndpoint"
                },
                "true"
            ]
        },
        "NeedToCreateCloudWatchMonitoringEndpoint": {
            "Fn::Equals": [
                {
                    "Ref": "CreateCloudWatchMonitoringEndpoint"
                },
                "true"
            ]
        },
        "NeedToCreateCloudWatchLogsEndpoint": {
            "Fn::Equals": [
                {
                    "Ref": "CreateCloudWatchLogsEndpoint"
                },
                "true"
            ]
        },
        "HasSnsTopicArn": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SnsTopicArn"
                        },
                        ""
                    ]
                }
            ]
        },
        "NeedToCreateWatchdogAlarm": {
            "Fn::And": [
                {
                    "Condition": "HasSnsTopicArn"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SendUsage"
                        },
                        "true"
                    ]
                }
            ]
        },
        "HasPasswordsSecret": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "PasswordsSecretArn"
                        },
                        ""
                    ]
                }
            ]
        },
        "IsCompleteStack": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentMode"
                        },
                        "FSx Metrics, FSx Alerts, EMS Logs"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentMode"
                        },
                        "FSx Metrics, FSx Alerts"
                    ]
                }
            ]
        },
        "IsEmsEnabled": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentMode"
                        },
                        "FSx Metrics, FSx Alerts, EMS Logs"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentMode"
                        },
                        "FSx EMS Logs"
                    ]
                }
            ]
        },
        "ShouldCreateEmsLogGroup": {
            "Fn::And": [
                {
                    "Condition": "IsEmsEnabled"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateEmsLogGroup"
                        },
                        "true"
                    ]
                }
            ]
        },
        "NeedToSendUsage": {
            "Fn::Equals": [
                {
                    "Ref": "SendUsage"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "NeedToCreateLambdaRole",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "BasicLambdaPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "fsx:DescribeFileSystems",
                                        "fsx:DescribeSnapshots",
                                        "fsx:DescribeBackups",
                                        "fsx:ListTagsForResource"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData",
                                        "cloudwatch:PutDashboard",
                                        "cloudwatch:GetDashboard",
                                        "cloudwatch:ListDashboards",
                                        "cloudwatch:DeleteDashboards",
                                        "cloudwatch:PutMetricAlarm",
                                        "cloudwatch:DeleteAlarms",
                                        "cloudwatch:DescribeAlarms"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${EmsLogGroupName}:*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "PasswordsSecretArn"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "NetAppEmsLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Condition": "ShouldCreateEmsLogGroup",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "LogGroupName": {
                    "Ref": "EmsLogGroupName"
                },
                "RetentionInDays": 14
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            "FSxNDashboard",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                },
                "Code": {
                    "ImageUri": {
                        "Fn::Sub": [
                            "052582346341.dkr.ecr.${Region}.amazonaws.com/fsx-monitoring-stack:production",
                            {
                                "Region": {
                                    "Ref": "AWS::Region"
                                }
                            }
                        ]
                    }
                },
                "Role": {
                    "Fn::If": [
                        "NeedToCreateLambdaRole",
                        {
                            "Fn::GetAtt": [
                                "LambdaRole",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "LambdaRoleArn"
                        }
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": {
                        "Ref": "SecurityGroupIds"
                    },
                    "SubnetIds": {
                        "Ref": "SubnetIds"
                    }
                },
                "PackageType": "Image",
                "Timeout": 90,
                "MemorySize": 256,
                "Environment": {
                    "Variables": {
                        "NODE_TLS_REJECT_UNAUTHORIZED": "0",
                        "Version": "1.0.0",
                        "Region": {
                            "Ref": "AWS::Region"
                        },
                        "SNS_ARN": {
                            "Ref": "SnsTopicArn"
                        },
                        "CLIENT_THROUGHPUT_ALARM_THRESHOLD": "90",
                        "DISK_PERFORMANCE_ALARM_THRESHOLD": "90",
                        "DISK_THROUGHPUT_UTILIZATION_ALARM_THRESHOLD": "90",
                        "SNAPMIRROR_UNHEALTHY_ALARM_THRESHOLD": "0",
                        "STORAGE_CAPACITY_UTILIZATION_ALARM_THRESHOLD": "80",
                        "VOLUME_STORAGE_CAPACITY_UTILIZATION_ALARM_THRESHOLD": "80",
                        "EMS_LOG_GROUP_NAME": {
                            "Ref": "EmsLogGroupName"
                        },
                        "LOG_FSX_COUNT": "false",
                        "LOG_ONTAP_EMS": {
                            "Fn::If": [
                                "IsEmsEnabled",
                                "true",
                                "false"
                            ]
                        }
                    }
                }
            }
        },
        "SchedulerRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "NeedToCreateSchedulerRole",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "scheduler.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "SchedulerLambdaInvokePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "lambda:InvokeFunction"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LambdaFunction",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EventBridgeScheduleGroup": {
            "Type": "AWS::Scheduler::ScheduleGroup",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            "FSxNDashboard",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                }
            }
        },
        "MetricsSchedule": {
            "Type": "AWS::Scheduler::Schedule",
            "Condition": "IsCompleteStack",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            "FSxNDashboard-metrics",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                },
                "GroupName": {
                    "Ref": "EventBridgeScheduleGroup"
                },
                "FlexibleTimeWindow": {
                    "Mode": "OFF"
                },
                "ScheduleExpression": "rate(1 minute)",
                "Target": {
                    "Arn": {
                        "Fn::GetAtt": [
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "RoleArn": {
                        "Fn::If": [
                            "NeedToCreateSchedulerRole",
                            {
                                "Fn::GetAtt": [
                                    "SchedulerRole",
                                    "Arn"
                                ]
                            },
                            {
                                "Ref": "SchedulerRoleArn"
                            }
                        ]
                    },
                    "Input": {
                        "Fn::Sub": [
                            "{\"action\": \"putMetricsCommand\", \"params\": {\"secretArn\": \"${SecretArn}\", \"region\": \"${Region}\"}}",
                            {
                                "SecretArn": {
                                    "Ref": "PasswordsSecretArn"
                                },
                                "Region": {
                                    "Ref": "AWS::Region"
                                }
                            }
                        ]
                    }
                }
            }
        },
        "DashboardSchedule": {
            "Type": "AWS::Scheduler::Schedule",
            "Condition": "IsCompleteStack",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            "FSxNDashboard-dashboard",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                },
                "GroupName": {
                    "Ref": "EventBridgeScheduleGroup"
                },
                "FlexibleTimeWindow": {
                    "Mode": "OFF"
                },
                "ScheduleExpression": "rate(1 hour)",
                "Target": {
                    "Arn": {
                        "Fn::GetAtt": [
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "RoleArn": {
                        "Fn::If": [
                            "NeedToCreateSchedulerRole",
                            {
                                "Fn::GetAtt": [
                                    "SchedulerRole",
                                    "Arn"
                                ]
                            },
                            {
                                "Ref": "SchedulerRoleArn"
                            }
                        ]
                    },
                    "Input": {
                        "Fn::Sub": [
                            "{\"action\": \"manageAlarmsCommand\", \"params\": {\"secretArn\": \"${SecretArn}\"}}",
                            {
                                "SecretArn": {
                                    "Ref": "PasswordsSecretArn"
                                }
                            }
                        ]
                    }
                }
            }
        },
        "EmsLogsSchedule": {
            "Type": "AWS::Scheduler::Schedule",
            "Condition": "IsEmsEnabled",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            "FSxNDashboard-ems-logs",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                },
                "GroupName": {
                    "Ref": "EventBridgeScheduleGroup"
                },
                "FlexibleTimeWindow": {
                    "Mode": "OFF"
                },
                "ScheduleExpression": {
                    "Fn::Sub": "rate(${EmsScheduleExpression} minutes)"
                },
                "Target": {
                    "Arn": {
                        "Fn::GetAtt": [
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "RoleArn": {
                        "Fn::If": [
                            "NeedToCreateSchedulerRole",
                            {
                                "Fn::GetAtt": [
                                    "SchedulerRole",
                                    "Arn"
                                ]
                            },
                            {
                                "Ref": "SchedulerRoleArn"
                            }
                        ]
                    },
                    "Input": {
                        "Fn::Sub": [
                            "{\"action\": \"streamEmsLogsCommand\", \"params\": {\"secretArn\": \"${SecretArn}\", \"region\": \"${Region}\", \"scheduleExpression\": \"rate(${Minutes} minutes)\"}}",
                            {
                                "SecretArn": {
                                    "Ref": "PasswordsSecretArn"
                                },
                                "Region": {
                                    "Ref": "AWS::Region"
                                },
                                "Minutes": {
                                    "Ref": "EmsScheduleExpression"
                                }
                            }
                        ]
                    }
                }
            }
        },
        "Dashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Condition": "IsCompleteStack",
            "DependsOn": "LambdaFunction",
            "Properties": {
                "DashboardBody": {
                    "Fn::Sub": [
                        "{\"variables\":[{\"type\":\"pattern\",\"pattern\":\"topFsx\",\"inputType\":\"input\",\"id\":\"topFsx\",\"label\":\"topFsx\",\"defaultValue\":\"5\",\"visible\":false},{\"type\":\"property\",\"property\":\"FileSystemName\",\"inputType\":\"input\",\"id\":\"FileSystemName\",\"label\":\"FileSystemName\",\"visible\":false},{\"type\":\"property\",\"property\":\"FileSystemId\",\"inputType\":\"input\",\"id\":\"FileSystemId\",\"label\":\"FileSystemId\",\"visible\":false},{\"type\":\"property\",\"property\":\"VolumeName\",\"inputType\":\"input\",\"id\":\"VolumeName\",\"label\":\"VolumeName\",\"visible\":false},{\"type\":\"property\",\"property\":\"VolumeId\",\"inputType\":\"input\",\"id\":\"VolumeId\",\"label\":\"VolumeId\",\"visible\":false},{\"type\":\"property\",\"property\":\"alarmCategory\",\"inputType\":\"input\",\"id\":\"alarmCategory\",\"label\":\"alarmCategory\",\"defaultValue\":\"All\",\"visible\":false},{\"type\":\"property\",\"property\":\"alarmState\",\"inputType\":\"input\",\"id\":\"alarmState\",\"label\":\"alarmState\",\"defaultValue\":\"All\",\"visible\":false},{\"type\":\"property\",\"property\":\"LunPath\",\"inputType\":\"input\",\"id\":\"LunPath\",\"label\":\"LunPath\",\"visible\":false}],\"widgets\":[{\"height\":4,\"width\":24,\"y\":0,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showFsxOverview\",\"limitFsx\":\"topFsx\",\"FileSystemId\":\"\",\"FileSystemName\":\"\",\"VolumeId\":\"\",\"VolumeName\":\"\",\"alarmCategory\":\"All\",\"alarmState\":\"All\",\"LunPath\":\"\"}}},{\"height\":8,\"width\":8,\"y\":4,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DataReadOperations\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"stat\":\"Sum\",\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Client Read Operations\"}},{\"height\":8,\"width\":8,\"y\":4,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DataWriteOperations\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"stat\":\"Sum\",\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Client Write Operations\"}},{\"height\":8,\"width\":8,\"y\":4,\"x\":16,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"MetadataOperations\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Client Metadata Operations\"}},{\"height\":8,\"width\":8,\"y\":12,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DataReadBytes\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))/1024/1024*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Client Read Megabytes\"}},{\"height\":8,\"width\":8,\"y\":12,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DataWriteBytes\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))/1024/1024*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Client Write Megabytes\"}},{\"height\":8,\"width\":8,\"y\":12,\"x\":16,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT AVG(StorageUsed) FROM SCHEMA(\\\"AWS/FSx\\\", DataType,FileSystemId,StorageTier) WHERE StorageTier = 'SSD' GROUP BY FileSystemId ORDER BY AVG() DESC LIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"visible\":false}],[{\"expression\":\"FLOOR(q1*9.313225746154785e-10)\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"GiB\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx SSD Storage Used\"}},{\"height\":8,\"width\":8,\"y\":20,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DiskReadOperations\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Disk Read Operations\"}},{\"height\":8,\"width\":8,\"y\":20,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DiskWriteOperations\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Disk Write Operations\"}},{\"height\":8,\"width\":8,\"y\":20,\"x\":16,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT AVG(StorageUsed) FROM SCHEMA(\\\"AWS/FSx\\\", DataType,FileSystemId,StorageTier) WHERE StorageTier = 'StandardCapacityPool' GROUP BY FileSystemId ORDER BY AVG() DESC LIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"visible\":false}],[{\"expression\":\"FLOOR(q1*9.313225746154785e-10)\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"GiB\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Capacity Pool\"}},{\"height\":8,\"width\":8,\"y\":28,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DiskReadBytes\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/1024/1024/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Disk Read Megabytes\"}},{\"height\":8,\"width\":8,\"y\":28,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT SUM(\\\"DiskWriteBytes\\\")\\nFROM SCHEMA(\\\"AWS/FSx\\\", \\\"FileSystemId\\\")\\nGROUP BY \\\"FileSystemId\\\"\\nORDER BY SUM() DESC\\nLIMIT topFsx\",\"label\":\"${LABEL}\",\"id\":\"q1\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(q1/1024/1024/PERIOD(FIRST(q1))*100)/100\",\"label\":\"\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Top topFsx NetApp-FSx Disk Write Megabytes\"}},{\"height\":6,\"width\":24,\"y\":36,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showMetricsByFsx\",\"limitFsx\":\"topFsx\",\"FileSystemId\":\"\",\"FileSystemName\":\"\",\"VolumeId\":\"\",\"VolumeName\":\"\",\"alarmCategory\":\"All\",\"alarmState\":\"All\",\"LunPath\":\"\"}}},{\"type\":\"metric\",\"x\":0,\"y\":42,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DataWriteOperations\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"m1\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DataReadOperations\",\".\",\".\",{\"id\":\"m2\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"MetadataOperations\",\".\",\".\",{\"id\":\"m3\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(m1/PERIOD(m1)*100)/100\",\"label\":\"Client Write OPS\",\"id\":\"e1\"}],[{\"expression\":\"FLOOR(m2/PERIOD(m2)*100)/100\",\"label\":\"Client Read OPS\",\"id\":\"e2\"}],[{\"expression\":\"FLOOR(m3/PERIOD(m3)*100)/100\",\"label\":\"Client Meta OPS\",\"id\":\"e3\"}],[{\"expression\":\"FLOOR(SUM(METRICS())/PERIOD(m2)*100)/100\",\"label\":\"Total Client OPS\",\"id\":\"e4\"}]],\"title\":\"Client IOPS\",\"view\":\"timeSeries\",\"period\":60,\"stacked\":false,\"stat\":\"Sum\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"region\":\"${AWS::Region}\"}},{\"type\":\"metric\",\"x\":8,\"y\":42,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DataReadBytes\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"m1\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DataWriteBytes\",\".\",\".\",{\"id\":\"m2\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[{\"id\":\"e1\",\"expression\":\"FLOOR(SUM(METRICS())/PERIOD(m1)/1024/1024*100)/100\",\"label\":\"Total client throughput\",\"color\":\"#1F77B4\"}],[{\"id\":\"e2\",\"expression\":\"FLOOR(m1/PERIOD(m1)/1024/1024*100)/100\",\"label\":\"Client MiB Read\"}],[{\"id\":\"e3\",\"expression\":\"FLOOR(m2/PERIOD(m2)/1024/1024*100)/100\",\"label\":\"Client MiB Written\"}]],\"view\":\"timeSeries\",\"title\":\"Client Throughput\",\"period\":60,\"stacked\":false,\"stat\":\"Sum\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"region\":\"${AWS::Region}\"}},{\"type\":\"metric\",\"x\":16,\"y\":42,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DiskReadOperations\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"m1\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DiskWriteOperations\",\".\",\".\",{\"id\":\"m2\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[{\"id\":\"e1\",\"expression\":\"FLOOR(m1/PERIOD(m1)*100)/100\",\"label\":\"Disk Read Ops\"}],[{\"id\":\"e2\",\"expression\":\"FLOOR(m2/PERIOD(m2)*100)/100\",\"label\":\"Disk Write Ops\"}],[{\"id\":\"e3\",\"expression\":\"FLOOR(SUM(METRICS())/PERIOD(m1)*100)/100\",\"label\":\"Total disk Ops\",\"region\":\"${AWS::Region}\",\"yAxis\":\"left\"}]],\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Disk OPS\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}}}},{\"type\":\"metric\",\"x\":0,\"y\":50,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DiskReadBytes\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"m1\",\"region\":\"${AWS::Region}\",\"label\":\"DiskReadBytes\",\"visible\":false}],[\".\",\"DiskWriteBytes\",\".\",\".\",{\"id\":\"m2\",\"region\":\"${AWS::Region}\",\"label\":\"DiskReadBytes\",\"visible\":false}],[{\"expression\":\"FLOOR(m1/1024/1024/PERIOD(m1)*100)/100\",\"label\":\"DiskReadMegabytes\",\"id\":\"e1\",\"region\":\"${AWS::Region}\",\"yAxis\":\"left\"}],[{\"expression\":\"FLOOR(m2/1024/1024/PERIOD(m2)*100)/100\",\"label\":\"DiskWriteMegabytes\",\"id\":\"e2\",\"region\":\"${AWS::Region}\",\"yAxis\":\"left\"}],[{\"expression\":\"FLOOR((e1+e2)*100)/100\",\"label\":\"Total disk MBs\",\"id\":\"e3\",\"region\":\"${AWS::Region}\",\"yAxis\":\"left\"}]],\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Disk Throughput\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}}}},{\"type\":\"metric\",\"x\":8,\"y\":50,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[{\"id\":\"e1\",\"expression\":\"FLOOR(1000 * m2/(m1+0.000001)*100)/100\",\"label\":\"Write operations\",\"color\":\"#1F77B4\",\"region\":\"${AWS::Region}\"}],[{\"id\":\"e2\",\"expression\":\"FLOOR(1000 * m4/(m3+0.000001)*100)/100\",\"label\":\"Read operations\",\"color\":\"#F89256\",\"region\":\"${AWS::Region}\"}],[{\"id\":\"e3\",\"expression\":\"FLOOR(1000 * m6/(m5+0.000001)*100)/100\",\"label\":\"Metadata operations\",\"color\":\"#2CA02C\",\"region\":\"${AWS::Region}\"}],[{\"id\":\"e4\",\"expression\":\"FLOOR((e1+e2+e3)*100)/100\",\"label\":\"Total operations\",\"region\":\"${AWS::Region}\"}],[\"AWS/FSx\",\"DataWriteOperations\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"m1\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DataWriteOperationTime\",\".\",\".\",{\"id\":\"m2\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DataReadOperations\",\".\",\".\",{\"id\":\"m3\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"DataReadOperationTime\",\".\",\".\",{\"id\":\"m4\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"MetadataOperations\",\".\",\".\",{\"id\":\"m5\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"MetadataOperationTime\",\".\",\".\",{\"id\":\"m6\",\"visible\":false,\"region\":\"${AWS::Region}\"}]],\"title\":\"Average Latency\",\"view\":\"timeSeries\",\"period\":60,\"stacked\":false,\"stat\":\"Sum\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Milliseconds\",\"min\":0}},\"region\":\"${AWS::Region}\"}},{\"type\":\"metric\",\"x\":16,\"y\":50,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[\"AWS/FSx\",\"StorageUsed\",\"FileSystemId\",\"\\\"\\\"\",\"StorageTier\",\"SSD\",\"DataType\",\"All\",{\"id\":\"m3\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[\".\",\"StorageCapacity\",\".\",\".\",\".\",\".\",\".\",\".\",{\"id\":\"m1\",\"visible\":false,\"region\":\"${AWS::Region}\"}],[{\"id\":\"e1\",\"expression\":\"FLOOR((m1-m3)/1024/1024/1024)\",\"label\":\"Primary tier - available\",\"color\":\"#2CA02C\",\"region\":\"${AWS::Region}\"}],[{\"id\":\"e2\",\"expression\":\"FLOOR(m3/1024/1024/1024)\",\"label\":\"Primary tier - used\",\"color\":\"#1F77B4\",\"region\":\"${AWS::Region}\"}]],\"title\":\"Primary Tier - Storage Utilization\",\"view\":\"pie\",\"period\":60,\"stacked\":false,\"stat\":\"Average\",\"yAxis\":{\"left\":{\"showUnits\":false}},\"region\":\"${AWS::Region}\"}},{\"type\":\"metric\",\"x\":0,\"y\":58,\"width\":8,\"height\":8,\"properties\":{\"metrics\":[[{\"expression\":\"FLOOR(m1*9.3132257461548E-10)\",\"label\":\"Capacity pool tier (GiB)\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}],[\"AWS/FSx\",\"StorageUsed\",\"FileSystemId\",\"\\\"\\\"\",\"StorageTier\",\"StandardCapacityPool\",\"DataType\",\"All\",{\"id\":\"m1\",\"label\":\"Capacity pool tier (Bytes)\",\"color\":\"#F89256\",\"region\":\"${AWS::Region}\",\"visible\":false}]],\"title\":\"Capacity Tier\",\"view\":\"singleValue\",\"period\":60,\"stacked\":false,\"stat\":\"Average\",\"yAxis\":{\"left\":{\"showUnits\":false}},\"region\":\"${AWS::Region}\"}},{\"height\":8,\"width\":8,\"y\":58,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/FSx\",\"CapacityPoolWriteBytes\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"write_bytes\",\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"visible\":false}],[{\"expression\":\"FLOOR((write_bytes/(1024*1024*1024))*100)/100\",\"id\":\"write_gib\",\"label\":\"Write data\",\"region\":\"${AWS::Region}\"}],[\"AWS/FSx\",\"CapacityPoolReadBytes\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"read_bytes\",\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"visible\":false}],[{\"expression\":\"FLOOR((read_bytes/(1024*1024*1024))*100)/100\",\"id\":\"read_gib\",\"label\":\"Read data\",\"region\":\"${AWS::Region}\"}]],\"title\":\"Capacity Pool Data\",\"view\":\"timeSeries\",\"period\":300,\"stacked\":false,\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"GiB\"}},\"region\":\"${AWS::Region}\"}},{\"height\":8,\"width\":8,\"y\":58,\"x\":16,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/FSx\",\"CapacityPoolWriteOperations\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"write_operations\",\"region\":\"${AWS::Region}\",\"label\":\"Write operations\"}],[\"AWS/FSx\",\"CapacityPoolReadOperations\",\"FileSystemId\",\"\\\"\\\"\",{\"id\":\"read_operations\",\"region\":\"${AWS::Region}\",\"label\":\"Read operations\"}]],\"title\":\"Capacity Pool Operations\",\"view\":\"timeSeries\",\"period\":300,\"stacked\":false,\"stat\":\"Sum\",\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations\"}},\"region\":\"${AWS::Region}\"}},{\"height\":8,\"width\":24,\"y\":66,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showSnapMirrorCommand\",\"FileSystemId\":\"\",\"secretArn\":\"${PasswordsSecretArn}\",\"region\":\"${AWS::Region}\"},\"title\":\"SnapMirror Relationships\"}},{\"height\":6,\"width\":24,\"y\":74,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showMetricsByVolume\",\"limitFsx\":\"topFsx\",\"FileSystemId\":\"\",\"FileSystemName\":\"\",\"VolumeId\":\"\",\"VolumeName\":\"\",\"alarmCategory\":\"All\",\"alarmState\":\"All\",\"LunPath\":\"\"}}},{\"height\":8,\"width\":8,\"y\":80,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/FSx\",\"StorageCapacityUtilization\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m1\",\"visible\":false}],[{\"expression\":\"FLOOR(m1)\",\"label\":\"StorageCapacityUtilization\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Percentage\",\"min\":0}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"Volume Utilization\"}},{\"height\":8,\"width\":8,\"y\":80,\"x\":8,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DataWriteOperations\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m1\",\"visible\":false}],[{\"expression\":\"FLOOR(m1/PERIOD(m1)*100)/100\",\"label\":\"DataWriteOperations\",\"id\":\"e2\",\"region\":\"${AWS::Region}\"}],[\"AWS/FSx\",\"DataReadOperations\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m2\",\"visible\":false}],[{\"expression\":\"FLOOR(m2/PERIOD(m2)*100)/100\",\"label\":\"DataReadOperations\",\"id\":\"e3\",\"region\":\"${AWS::Region}\"}],[\"AWS/FSx\",\"MetadataOperations\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m3\",\"visible\":false}],[{\"expression\":\"FLOOR(m3/PERIOD(m3)*100)/100\",\"label\":\"MetadataOperations\",\"id\":\"e4\",\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(SUM(METRICS())/PERIOD(m1)*100)/100\",\"label\":\"Total IOPS\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Volume IOPS\"}},{\"height\":8,\"width\":8,\"y\":80,\"x\":16,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/FSx\",\"DataReadBytes\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m1\",\"label\":\"DataReadBytes\",\"visible\":false}],[\"AWS/FSx\",\"DataWriteBytes\",\"VolumeId\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"m2\",\"label\":\"DataWriteBytes\",\"visible\":false}],[{\"expression\":\"FLOOR(m1/PERIOD(m1)/1024/1024*100)/100\",\"label\":\"DataReadMiB\",\"id\":\"e1\",\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(m2/PERIOD(m2)/1024/1024*100)/100\",\"label\":\"DataWriteMiB\",\"id\":\"e2\",\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(SUM(METRICS())/PERIOD(m1)/1024/1024*100)/100\",\"label\":\"Total Throughput\",\"id\":\"e3\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Sum\",\"period\":300,\"title\":\"Volume Throughput\"}},{\"height\":8,\"width\":24,\"y\":88,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[{\"expression\":\"SELECT AVG(LUN_Throughput_Total) FROM \\\"Netapp::FSx::Lun\\\" WHERE FileSystemId = '${FileSystemId}' GROUP BY LunPath ORDER BY AVG() DESC LIMIT 5\",\"label\":\"${LABEL}\",\"id\":\"throughput_total_bps\",\"region\":\"${AWS::Region}\",\"period\":300,\"visible\":false}],[{\"expression\":\"FLOOR(throughput_total_bps/1024/1024*100)/100\",\"id\":\"throughput_total_MiB\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"period\":300,\"title\":\"Top 5 LUNs Throughput Path\"}},{\"height\":8,\"width\":12,\"y\":96,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showMetricsByLun\",\"limitFsx\":\"topFsx\",\"FileSystemId\":\"\",\"FileSystemName\":\"\",\"VolumeId\":\"\",\"VolumeName\":\"\",\"alarmCategory\":\"All\",\"alarmState\":\"All\",\"secretArn\":\"${PasswordsSecretArn}\",\"region\":\"${AWS::Region}\",\"LunPath\":\"\"}}},{\"height\":8,\"width\":12,\"y\":96,\"x\":12,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"Netapp::FSx::Lun\",\"LUN_Throughput_Read\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_read_bps\",\"visible\":false,\"label\":\"raw_read_metric\"}],[{\"expression\":\"FLOOR(raw_read_bps/1024/1024*100)/100\",\"label\":\"Data_Read_MiB\",\"id\":\"read_metric_rounded\",\"region\":\"${AWS::Region}\"}],[\"Netapp::FSx::Lun\",\"LUN_Throughput_Write\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_write_bps\",\"visible\":false,\"label\":\"raw_write_metric\"}],[{\"expression\":\"FLOOR(raw_write_bps/1024/1024*100)/100\",\"label\":\"Data_Write_MiB\",\"id\":\"write_metric_rounded\",\"region\":\"${AWS::Region}\"}],[\"Netapp::FSx::Lun\",\"LUN_Throughput_Total\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_total_bps\",\"visible\":false,\"label\":\"raw_total_metric\"}],[{\"expression\":\"FLOOR(raw_total_bps/1024/1024*100)/100\",\"label\":\"Data_Total_MiB\",\"id\":\"total_metric_rounded\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"MiB per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"LUN Throughput\"}},{\"height\":8,\"width\":12,\"y\":104,\"x\":0,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"Netapp::FSx::Lun\",\"LUN_IOPS_Read\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_read\",\"label\":\"Read_OPS\"}],[\"Netapp::FSx::Lun\",\"LUN_IOPS_Write\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_write\",\"label\":\"Write_OPS\"}],[\"Netapp::FSx::Lun\",\"LUN_IOPS_Total\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_total\",\"label\":\"Total_OPS\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Operations per second\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"LUN IOPS\"}},{\"height\":8,\"width\":12,\"y\":104,\"x\":12,\"type\":\"metric\",\"properties\":{\"metrics\":[[\"Netapp::FSx::Lun\",\"LUN_Latency_Read\",\"LunPath\",\"\\\"\\\"\",\"FileSystemId\",\"\\\"\\\"\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_read_microseconds\",\"label\":\"Latency_Read_Microseconds\",\"visible\":false}],[\".\",\"LUN_Latency_Write\",\".\",\".\",\".\",\".\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_write_microseconds\",\"label\":\"Latency_Write_Microseconds\",\"visible\":false}],[\".\",\"LUN_Latency_Total\",\".\",\".\",\".\",\".\",{\"region\":\"${AWS::Region}\",\"id\":\"raw_total_microseconds\",\"label\":\"Latency_Total_Microseconds\",\"visible\":false}],[{\"expression\":\"FLOOR(raw_read_microseconds/1000*100)/100\",\"label\":\"Latency_Read\",\"id\":\"read_milliseconds_rounded\",\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(raw_write_microseconds/1000*100)/100\",\"label\":\"Latency_Write\",\"id\":\"write_milliseconds_rounded\",\"region\":\"${AWS::Region}\"}],[{\"expression\":\"FLOOR(raw_total_microseconds/1000*100)/100\",\"label\":\"Latency_Total\",\"id\":\"total_milliseconds_rounded\",\"region\":\"${AWS::Region}\"}]],\"yAxis\":{\"left\":{\"showUnits\":false,\"label\":\"Milliseconds\"}},\"view\":\"timeSeries\",\"stacked\":false,\"region\":\"${AWS::Region}\",\"stat\":\"Average\",\"period\":300,\"title\":\"LUN Latency\"}},{\"width\":24,\"height\":20,\"y\":112,\"x\":0,\"type\":\"custom\",\"properties\":{\"endpoint\":\"${LambdaEndpoint}\",\"updateOn\":{\"refresh\":true,\"resize\":true,\"timeRange\":true},\"params\":{\"action\":\"showAlarms\",\"limitFsx\":\"topFsx\",\"FileSystemId\":\"\",\"FileSystemName\":\"\",\"VolumeId\":\"\",\"VolumeName\":\"\",\"alarmCategory\":\"All\",\"alarmState\":\"All\",\"LunPath\":\"\"}}}]}",
                        {
                            "LambdaEndpoint": {
                                "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"
                            },
                            "PasswordsSecretArn": {
                                "Ref": "PasswordsSecretArn"
                            },
                            "LABEL": "${LABEL}",
                            "FileSystemId": "${FileSystemId}"
                        }
                    ]
                },
                "DashboardName": {
                    "Fn::Join": [
                        "-",
                        [
                            "NetApp-FSx-Dashboard",
                            {
                                "Ref": "AWS::Region"
                            },
                            {
                                "Fn::Select": [
                                    "4",
                                    {
                                        "Fn::Split": [
                                            "-",
                                            {
                                                "Fn::Select": [
                                                    2,
                                                    {
                                                        "Fn::Split": [
                                                            "/",
                                                            {
                                                                "Ref": "AWS::StackId"
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    ]
                }
            }
        },
        "SecretManagerEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateSecretManagerEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VpcId"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.secretsmanager"
                },
                "VpcEndpointType": "Interface",
                "SubnetIds": {
                    "Ref": "SubnetIds"
                },
                "SecurityGroupIds": {
                    "Ref": "SecurityGroupIds"
                }
            }
        },
        "FSxEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateFsxServiceEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VpcId"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.fsx"
                },
                "VpcEndpointType": "Interface",
                "SubnetIds": {
                    "Ref": "SubnetIds"
                },
                "SecurityGroupIds": {
                    "Ref": "SecurityGroupIds"
                }
            }
        },
        "CloudWatchEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateCloudWatchMonitoringEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VpcId"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.monitoring"
                },
                "VpcEndpointType": "Interface",
                "SubnetIds": {
                    "Ref": "SubnetIds"
                },
                "SecurityGroupIds": {
                    "Ref": "SecurityGroupIds"
                }
            }
        },
        "CloudWatchLogsEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateCloudWatchLogsEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VpcId"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.logs"
                },
                "VpcEndpointType": "Interface",
                "SubnetIds": {
                    "Ref": "SubnetIds"
                },
                "SecurityGroupIds": {
                    "Ref": "SecurityGroupIds"
                }
            }
        },
        "WatchdogAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "NeedToCreateWatchdogAlarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "FSxNDashboard-Watchdog-${AWS::StackName}"
                },
                "AlarmDescription": "Monitor Lambda function execution for FSx Dashboard",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "LambdaFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SnsTopicArn"
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "SendDeploymentUsage": {
            "Type": "Custom::ReportUsage",
            "Condition": "NeedToSendUsage",
            "Properties": {
                "ServiceToken": {
                    "Fn::Sub": [
                        "arn:aws:lambda:${Region}:052582346341:function:reporting-monitoring-dashboard-usage",
                        {
                            "Region": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "Region": {
                    "Ref": "AWS::Region"
                },
                "Source": "MonitoringDashboard"
            }
        }
    },
    "Outputs": {
        "LambdaFunctionName": {
            "Description": "Name of the Lambda function",
            "Value": {
                "Ref": "LambdaFunction"
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaFunction",
                    "Arn"
                ]
            }
        },
        "LambdaRoleArn": {
            "Description": "ARN of the Lambda execution role",
            "Value": {
                "Fn::If": [
                    "NeedToCreateLambdaRole",
                    {
                        "Fn::GetAtt": [
                            "LambdaRole",
                            "Arn"
                        ]
                    },
                    {
                        "Ref": "LambdaRoleArn"
                    }
                ]
            }
        },
        "ScheduleGroupName": {
            "Description": "Name of the EventBridge Schedule Group",
            "Value": {
                "Ref": "EventBridgeScheduleGroup"
            }
        }
    }
}
