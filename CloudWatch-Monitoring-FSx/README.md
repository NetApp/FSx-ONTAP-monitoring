# AWS CloudWatch Dashboard and alerts for FSx for ONTAP

## Introduction
This sample provides a CloudFormation template to deploy a monitoring solution. It provides three main functions:
- A single AWS CloudWatch dashboard specifically designed for monitoring all your FSx for ONTAP file systems in a region.
- Management of CloudWatch alarms.
- Capture of EMS message from FSxN file systems and store them into CloudWatch Logs LogStream.

### Deployment Modes
There are three deployment modes available to suit different monitoring needs:

#### Full Stack Mode
"FSx Metrics, FSx Alerts, EMS Logs"
* Complete monitoring solution
* Performance metrics collection
* Automated alerting system
* Event Management System logs
* Comprehensive dashboard

#### Monitoring Only Mode
"FSx Metrics, FSx Alerts"
* Performance monitoring
* CloudWatch alarms
* Dashboard creation
* No EMS log collection
* Reduced resource usage

#### EMS Logs Only Mode
"FSx EMS Logs"
* Event log streaming only
* CloudWatch Logs integration
* Configurable collection interval
* No performance metrics
* Minimal infrastructure

### Dashboard
Here is a screenshot of the top portion of the dashboard created by this solution:
![Screenshot](images/CW-Dashboard-Screenshot.png)

#### Dashboard Sections
The following is a brief description of each section of the dashboard:
| Section | Metrics Displayed | Purpose |
|-----------------|-------------------|---------|
| Client Operations | Read/Write/Metadata IOPS, Throughput (MiB/s) | Monitor client-side performance and activity|
| Storage Utilization | SSD tier usage, Capacity pool consumption | Track storage capacity and tiering efficiency |
| Disk Performance | Disk IOPS, Disk throughput, Backend operations | Monitor underlying storage performance |
| Latency Metrics| Average response times for Read/Write/Metadata | Identify performance bottlenecks |
| Volume-Level Stats | Per-volume IOPS, throughput, capacity utilization | Granular volume performance monitoring |
| LUN Performance | iSCSI LUN IOPS, throughput, latency | Block storage protocol monitoring |
| SnapMirror Status | Replication relationship health | Data protection monitoring |
| Alarm Overview | Active alarms, alarm states, categories | Centralized alert management |

### CloudWatch Alarms
This solution automatically creates CloudWatch alarms for the following FSxN attributes:
- Disk throughput utilization
- Disk IOPS utilization
- SSD storage capacity utilization
- Volume storage capacity utilization
- SnapMirror unhealthy relationships

### EMS Messages
The solution collects EMS messages directly from the ONTAP systems and sends them to CloudWatch Logs. This allows you
to monitor and analyze system events and alerts generated by your FSx for ONTAP file systems.
![EMS Logs](./images/EMS-Cloudwatch-Logs.png)

## Architecture
This solution consists of the following components:
1. CloudWatch Dashboard
1. Lambda function - This function performs the following actions:
    1. Build custom widgets for the dashboard.
    1. Collects metrics directly from FSxN (like snapmirror health status).
    1. Creates and deletes CloudWatch alarms for various components of all the FSxN file systems in the region.
    1. Collects EMS message directly from FSxN.
1. Schedulers - Three AWS EventBridge schedulers that trigger the Lambda function to:
    1. Collect ONTAP metrics. Scheduled to trigger every minute.
    1. Create, update or delete CloudWatch alarms. Scheduled to trigger once an hour.
    1. Collect EMS messages. Configurable interval, default to every 5 minutes.
1. A CloudWatch alarm that will alert you when the Lambda function fails. Not created if you don't provide an SNS Topic to send alerts to.
1. Lambda Role - The IAM role that allows the Lambda function to run. This is optional and only created if you don't provide a role ARN for the Lambda function to use. The required permissions are listed below.
1. Scheduler Role - The IAM role that allows the scheduler to trigger the Lambda function. This is optional and only created if you don't provide a role ARN for the scheduler to use. The required permissions are listed below.
1. SecretsManager endpoint - The Lambda function runs inside a VPC, which by default lacks outgoing internet connectivity. To
enable the function to securely access the fsx credentials stored in AWS Secrets Manager, a VPC endpoint for the Secrets
Manager service might be required. This endpoint allows the Lambda function to retrieve sensitive information from Secrets Manager
without needing direct internet access, maintaining security while ensuring the function can access the necessary credentials.
1. CloudWatch endpoint - The Lambda function runs inside a VPC, which by default lacks outgoing internet connectivity. To enable
the function to send logs and metrics to CloudWatch, a VPC endpoint for the CloudWatch service might be required. This endpoint allows
the Lambda function to communicate with CloudWatch without needing direct internet access, maintaining security while ensuring
proper monitoring and logging functionality.
1. FSxService endpoint - The Lambda function runs inside a VPC, which by default lacks outgoing internet connectivity. To enable the 
function to send calls to FSxService to retrieve file systems information and metrics, a VPC endpoint for the FSxService might be required.

### Permissions required
#### Lambda Role
The following permissions are required for the Lambda function to run:
| Permission | Reason |
|:-----------|:-------|
| AWSLambdaVPCAccessExecutionRole<br>(AWS managed Policy) | Provides the required permissions to allow the Lambda function to run inside a VPC |
| secretsmanager:GetSecretValue | To retrieve fsx credentials from Secrets Manager |
| fsx:DescribeFileSystems | To list all FSxN file systems in the region |
| fsx:DescribeVolumes | To list all volumes in each FSxN file system |
| fsx:ListTagsForResource | To retrieve tags to override alarm thresholds or skip alarm management |
| cloudwatch:DescribeAlarms | To list existing CloudWatch alarms |
| cloudwatch:PutMetricData | To send LUN metrics to CloudWatch |
| cloudwatch:PutMetricAlarm | To create CloudWatch alarms |
| cloudwatch:DeleteAlarms | To delete CloudWatch alarms created |
| logs:CreateLogGroup | To create CloudWatch Logs Log Group for EMS messages |
| logs:CreateLogStream | To create CloudWatch Logs Log Stream for EMS messages |
| logs:PutLogEvents | To send EMS messages to CloudWatch Logs |
| logs:DescribeLogGroups | To check if the CloudWatch Logs log group exists |
| logs:DescribeLogStreams | To check if the CloudWatch Logs log stream exists |

#### Scheduler Role
The following permissions are required for the scheduler to trigger the Lambda function:
| Permission | Reason |
|:-----------|:-------|
| lambda:InvokeFunction | To allow the scheduler to trigger the Lambda function |

## Implementation
Depending on which deployment mode you select, the CloudFormation template will create the following resources:

| Resource | Full stack | Monitoring only | EMS logs only | Description |
|:---------|:----------:|:---------------:|:-------------:|:------------|
| Dashboard | Yes | Yes | No |  The Amazon CloudWatch dashboard |
| Lambda function | Yes | Yes | Yes | The service does the following:<br>o Build custom widgets for the dashboard.<br>o Collect metrics directly from ONTAP (like SnapMirror health status and EMS messages).<br>o Create CloudWatch alarms for all files systems in the region.|
| Schedulers | Yes | Yes | Yes | Three Amazon EventBridge schedulers that trigger the Lambda function to:<br>o Collect ONTAP metrics.<br>o Create, update or delete CloudWatch alarms.<br>o Collect EMS messages|
| CloudWatch alarm | Yes | Yes | No | This alarm will alert you if the Lambda function fails. Not created if you don't provide an SNS Topic to send alerts to.|
| Lambda Role | Yes | Yes | Yes | The IAM role that allows the Lambda function to run. This is optional if you don't provide a role ARN for the Lambda function to use.|
| Scheduler Role | Yes | Yes | Yes | The IAM role that allows the scheduler to trigger the Lambda function. This is optional if you don't provide a role ARN for the scheduler to use. |
| SecretManager endpoint | Yes | Yes | Yes | This allows the Lambda function to access the SecretManager API. It is optional and only needed if the Lambda function is deployed into a "Public" subnet. |
| CloudWatch endpoint | Optional | Optional | Optional | This allows the Lambda function to access the CloudWatch API. It is optional and only needed if the Lambda function is deployed into a "Public" subnet. |
| FSxService endpoint | Optional | Optional | Optional | This allows the Lambda function to access the FSxService API. It is optional and only needed if the Lambda function is deployed into a "Public" subnet. |
| CloudWatch Logs endpoint | Optional | Optional | Optional | This allows the Lambda function to access the CloudWatch Logs API. It is optional and only needed if the Lambda function is deployed into a "Public" subnet. |

## Prerequisites
1. You should have an AWS Account with the following permissions to create and manage resources:
    * "cloudformation:DescribeStacks"
    * "cloudformation:ListStacks"
    * "cloudformation:DescribeStackEvents"
    * "cloudformation:ListStackResources"
    * "cloudformation:CreateChangeSet"
    * "ec2:DescribeSubnets"
    * "ec2:DescribeSecurityGroups"
    * "ec2:DescribeVpcs"
    * "iam:ListRoles"
    * "iam:GetRolePolicy"
    * "iam:GetRole"
    * "iam:DeleteRolePolicy"
    * "iam:CreateRole"
    * "iam:DetachRolePolicy"
    * "iam:PassRole"
    * "iam:PutRolePolicy"
    * "iam:DeleteRole"
    * "iam:AttachRolePolicy"
    * "lambda:AddPermission"
    * "lambda:RemovePermission"
    * "lambda:InvokeFunction"
    * "lambda:GetFunction"
    * "lambda:CreateFunction"
    * "lambda:DeleteFunction"
    * "lambda:TagResource"
    * "codestar-connections:GetSyncConfiguration"
    * "ecr:BatchGetImage"
    * "ecr:GetDownloadUrlForLayer"
    * "scheduler:GetSchedule"
    * "scheduler:CreateSchedule"
    * "scheduler:DeleteSchedule"
    * "logs:PutRetentionPolicy"
    * "secretsmanager:GetSecretValue" (on specific secret)
2. A AWS SecretsManager secret with key-value pairs of file system IDs and their corresponding credentials value.  
Value can be provided in two formats. The first format is simply the password for the 'fsxadmin' user. The second
format includes both the username and password, separated by a colon. This secret is necessary for making direct
ONTAP API calls to monitor resources, such as SnapMirror relations and obtaining the EMS messages.

Examples secret structure:
```
    {
        "fs-111222333": "Password1",
        "fs-444555666": "Password2"
    }
    or 
    {
        "fs-111222333": "myUserName:Password1",
        "fs-444555666": "Password2"
    }	
```
When deploying the CloudFormation template, you will need to provide the ARN of this secret as a parameter.
This allows the Lambda function to securely access the passwords for monitoring purposes.
Note: If you choose not to provide this secret, some monitoring capabilities (such as SnapMirror relations metrics) may be limited.
 
## Usage
To use this solution, you will need to run the CloudFormation template in your AWS account.
The CloudFormation template requires the following parameters:

1. Stack name - Identifier for the CloudFormation stack. Must not exceed 25 characters. (Note: While AWS allows stack names up to 
128 characters, limit yours to 25. This name is used as base name for other resource names created within the stack, so keeping
it short prevents issues with other resource names getting too long.)
2. VPC ID - The ID of the VPC in which the Lambda function will run. This VPC must have connectivity to all target file systems. It 
can be either the same VPC where the file systems are located, or a different VPC with established connectivity (e.g. VPC peering, Transit Gateway) to the file systems' VPCs.
3. Subnet IDs - The IDs of the subnets in which the Lambda function will run. These subnets must have connectivity to the file 		
systems.
4. Security Group IDs - The IDs of the Security Groups that will be associated with the Lambda function when it runs. These Security 
Groups must allow connectivity to the file systems over TCP port 443. It needs no inbound rules.
5. Deployment Mode - Select one of the three deployment modes: "Fsx Metrics, FSx Alerts, EMS Logs", "FSx Metrics, FSx Alerts", or "FSx EMS Logs".
5. Create FSx Service Endpoint - A boolean flag indicating whether you plan to create a FSxService VPC endpoint inside the VPC. Set 
this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint in the subnet where the Lambda function is to run. If you already have one, set this to false; otherwise, set it to true.	
6. Create Secrets Manager Endpoint - A boolean flag indicating whether you plan to create a Secrets Manager VPC endpoint inside the 
VPC. Set this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint in the subnet where the Lambda function is to run. If you already have one, set this to false; otherwise, set it to true.
7. Create CloudWatch Endpoint - A boolean flag indicating whether you plan to create a CloudWatch VPC endpoint inside the VPC. Set 
this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint in the subnet where the Lambda function is to run. If you already have one, set this to false; otherwise, set it to true.
8. Lambda Role ARN - Optional - The ARN of the IAM role that the Lambda function will use when it runs. If not provided, a new role with the required permissions will be created.
9. Scheduler Role ARN - Optional - The ARN of the IAM role that the scheduler will use to trigger the Lambda function. If not provided, a new role with the required permissions will be created.
10. Secret Manager FSx Admin Passwords ARN - The ARN of the AWS Secrets Manager secret containing the fsx credentials.
This ARN is required for certain functionalities, such as snapmirror metrics collection. 
If not provided, some features may not operate correctly. This secret should contain key-value pairs as described in Prerequisites section above.
11. SNS Topic ARN for CloudWatch alarms - Optional - The ARN of the SNS topic to which CloudWatch alarms will be sent. If not provided, alarms will not be notified to any SNS topic.
11. EMS Collection Interval (minutes) - The interval, in minutes, at which EMS messages will be collected from the file systems. The default value is 5 minutes.
11. EMS CloudWatch Log Group Name - The name of the CloudWatch Logs log group where EMS messages will be stored. The default value is "fsx-ems-logs".
11. Create EMS Log Group - A boolean flag indicating whether to create the CloudWatch Logs log group for EMS messages. Set this to true to create the log group, or false if you plan to create it manually beforehand.
12. Send usage data to NetApp - A boolean flag indicating whether you agree to send anonymous usage data to NetApp. This data helps us improve our solutions. No personal or sensitive information is collected.

## Alarms Configuration
The Lambda function is responsible for creating alarms based on the thresholds set via environment variables. These environment variables can be set from the AWS console, under the Configuration tab of the dashboard Lambda function. You can find the specific Lambda function by its name “FSxNDashboard-<CloudFormation-Stack-Name>.
The following environment variables are used:
1. CLIENT_THROUGHPUT_ALARM_THRESHOLD: This sets the threshold for the client throughput alarm. The default value is "90", but this can be customized as needed. When the client throughput exceeds this value (expressed as a percentage), an alarm will be triggered.
1. DISK_PERFORMANCE_ALARM_THRESHOLD: This sets the threshold for the disk performance alarm. The default value is "90", but this can be customized as needed. When the disk performance exceeds this value (expressed as a percentage), an alarm will be triggered.
1. DISK_THROUGHPUT_UTILIZATION_ALARM_THRESHOLD: This sets the threshold for the disk throughput utilization alarm. The default value is "90", but this can be customized as needed. When disk throughput utilization exceeds this value (expressed as a percentage), an alarm will be triggered.
1. SNAPMIRROR_UNHEALTHY_ALARM_THRESHOLD: This sets the threshold for the SnapMirror unhealthy alarm. The default value is "0", but this can be customized as needed. When the number of unhealthy SnapMirror relationships exceeds this value, an alarm will be triggered.
1. STORAGE_CAPACITY_UTILIZATION_ALARM_THRESHOLD: This sets the threshold for the storage capacity utilization alarm. The default value is "80", but this can be customized as needed. When storage capacity utilization exceeds this value (expressed as a percentage), an alarm will be triggered.
1. VOLUME_STORAGE_CAPACITY_UTILIZATION_ALARM_THRESHOLD: This sets the threshold for the volume storage capacity utilization alarm. The default value is "80", but this can be customized as needed. When volume storage capacity utilization exceeds this value (expressed as a percentage), an alarm will be triggered.

In addition to the environment variables, you can use tags on the FSx and volume resources to override default thresholds or skip alarm management for specific resources. If a threshold is set to 100, the alarm will not be created. Similarly, skip tag is set to true, the alarm will be skipped.

The tag keys used for this purpose are:

1. client-throughput-alarm-threshold
1. skip-client-throughput-alarm
1. disk-performance-alarm-threshold
1. skip-disk-performance-alarm
1. disk-throughput-utilization-threshold
1. skip-disk-throughput-utilization-alarm
1. storage-capacity-utilization-alarm-threshold
1. skip-storage-capacity-utilization-alarm
1. volume-storage-capacity-utilization-alarm-threshold
1. skip-volume-storage-capacity-utilization-alarm
1. snapMirror-unhealthy-relations-alarm-threshold
1. skip-snapmirror-unhealthy-relations-alarm

## Important Disclaimer: CloudWatch Alarms Deletion
Please note that when you delete the CloudFormation stack associated with this project, the CloudWatch Alarms created by the stack will not be automatically deleted. 

CloudFormation does not manage the lifecycle of CloudWatch Alarms created by the Lambda function. This means that even after stack deletion, these alarms will persist in your AWS account.

To fully clean up resources after using this solution:
1. Delete the CloudFormation stack as usual.
2. Manually review and delete any associated CloudWatch Alarms through the AWS Console or using AWS CLI/SDK.
You can find the alarms by searching for the name prefix "FSx-ONTAP" in the CloudWatch Alarms section.

This behavior ensures that important monitoring setups are not unintentionally removed, but it requires additional steps for complete resource cleanup.

## Author Information

This repository is maintained by the contributors listed on [GitHub](https://github.com/NetApp/FSx-ONTAP-monitoring/graphs/contributors).

## License

Licensed under the Apache License, Version 2.0 (the "License").

You may obtain a copy of the License at [apache.org/licenses/LICENSE-2.0](http://www.apache.org/licenses/LICENSE-2.0).
 
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" basis, without WARRANTIES or conditions of any kind, either express or implied.

See the License for the specific language governing permissions and limitations under the License.
