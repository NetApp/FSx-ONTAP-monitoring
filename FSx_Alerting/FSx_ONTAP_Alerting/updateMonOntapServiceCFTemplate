#!/bin/bash
#
# This script is used to update the CloudFormation template with the latest
# version of the Lambda function. It will also update the version number in
# the template.
#################################################################################

majorVersionNum=4
file="monitor_ontap_services.py"
monitorCodeChanged=1
controllerCodeChanged=1

tmpfile1=$(mktemp /tmp/tmpfile1.XXXXXX)
tmpfile2=$(mktemp /tmp/tmpfile2.XXXXXX)
trap "rm -f $tmpfile1 $tmpfile2" exit
#
# First get the monitoring code out of the CF template so we can compare it.
# Assume it is the last thing in the file.
sed -e '1,\(#!/bin/python3(d' cloudformation.yaml > cloudformation.yaml.tmp
#
# Now get the Date and Version lines out of both files so that's not included in the diff.
egrep -v '^          # Date:|^          # Version' cloudformation.yaml.tmp > $tmpfile1
sed -e 1d $file | egrep -v '^# Date:|^# Version:' > $tmpfile2
#
# Now compare the two ignoring whitespace.
if diff -w $tmpfile1 $tmpfile2 > /dev/null; then
  echo "No changes to the monitor code."
  monitorCodeChanged=0
fi
#
# Now check the controller code by first stripping it out of the CF template.
sed -e '1,\(# BEGIN CONTROLLER CODE(d' cloudformation.yaml > $tmpfile2
sed -e '\(# END CONTROLLER CODE(,$d' $tmpfile2 > $tmpfile1
# String the BEGIN and END lines and compare to controller.py
sed -e 1,2d -e '$d' controller.py > $tmpfile2
if diff -w $tmpfile1 $tmpfile2 > /dev/null; then
  echo "No changes to the controller code."
  controllerCodeChanged=0
fi

if [ $monitorCodeChanged -eq 0 -a $controllerCodeChanged -eq 0 ]; then
  echo "No changes to CloudFormation template required."
  rm -f cloudformation.yaml.tmp
  rm -f $tmpfile1 $tmpfile2
  exit 0
fi

if [ $monitorCodeChanged -eq 1 ]; then
  echo "Updating monitor code in CloudFormation template."
  #
  # Get the number of commits in the git history for the file to calculate the minor version number.
  minorVersionNum="$(git log "$file" | egrep '^commit' | wc -l)"
  if [ -z "$minorVersionNum" ]; then
    echo "Failed to calculate version number." 1>&2
    exit 1
  fi

  version="v${majorVersionNum}.${minorVersionNum}"
  #
  # Strip out the monitoring code.
  sed -e '\(#!/bin/python3(,$d' cloudformation.yaml > cloudformation.yaml.tmp
  #
  # Add the monitoring code to the CF template while updating the version and date.
  cat "$file" | sed -e 's/^/          /' -e "s/%%VERSION%%/${version}/" -e "s/%%DATE%%/$(date +%Y-%m-%d-%H:%M:%S)/" >> cloudformation.yaml.tmp
  mv cloudformation.yaml.tmp cloudformation.yaml
fi

if [ $controllerCodeChanged -eq 1 ]; then
  echo "Updating controller code in CloudFormation template."

  sed -e '\(# BEGIN CONTROLLER CODE(,$d' cloudformation.yaml > $tmpfile1  # Before the controller code.
  sed -e '1,\(# END CONTROLLER CODE(d' cloudformation.yaml > $tmpfile2    # After the controller code.
  sed -e 1d -e 's/^/          /' controller.py >> $tmpfile1               # Add the updated controller code.
  cat $tmpfile1 $tmpfile2 > cloudformation.yaml                           # Add the after part back.
fi
